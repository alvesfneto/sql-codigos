
/*
diante da solicitação abaixo, do setor de Parcerias, 
pedimos o arquivo com escolas próximas até 2,0 km 
da CEI PINOCCHIO IV - 308799

*/


SELECT
DRE,
CD_ESCOLA,
SG_TP_ESCOLA,
NOMESC,
CD_COORDENADA_GEO_X AS LON,
CD_COORDENADA_GEO_Y AS LAT
INTO ##308799
FROM SME_ESCOLA_DIARIO WHERE CD_ESCOLA= 308799

DROP TABLE ##ESCOLAS_PROXIMAS_309799
SELECT
A.DRE,
A.CD_ESCOLA,
A.SG_TP_ESCOLA,
A.NOMESC,
A.CD_COORDENADA_GEO_Y AS LAT,
A.CD_COORDENADA_GEO_X AS LON,
FLOOR(FLOOR(SQRT(POWER(((A.CD_COORDENADA_GEO_X*1000000) - (B.LON * 1000000) ),2) +  
			POWER(((A.CD_COORDENADA_GEO_Y*1000000)  - (B.LAT * 1000000)),2)) / 10)/0.6) AS DISTANCIA,
CONVERT(VARCHAR,A.CRDATE-1,103) AS DT_BASE
INTO ##ESCOLAS_PROXIMAS_309799
FROM SME_ESCOLA_DIARIO A, ##308799 B
WHERE (FLOOR(SQRT(POWER(((A.CD_COORDENADA_GEO_X*1000000) - (B.LON * 1000000) ),2) +  
			POWER(((A.CD_COORDENADA_GEO_Y*1000000)  - (B.LAT * 1000000)),2)) / 10)/0.6)<=2000
AND A.TP_ESCOLA IN (10,11,12,18,28,31) AND A.CD_ESCOLA<>308799 AND A.CD_SIT=1
--SELECT * FROM ##ESCOLAS_PROXIMAS_309799

SELECT 
A.DRE,
A.CD_ESCOLA,
A.SG_TP_ESCOLA,
A.NOME_ESCOLA,
B.DISTANCIA AS DIST_UNIDADES,
FLOOR(FLOOR(SQRT(POWER(((LON_ALUNO*1000000) - (B.LON * 1000000) ),2) +  
				 POWER(((LAT_ALUNO*1000000) - (B.LAT * 1000000)),2)) / 10)/0.6) AS DIST_ALU_NOVA

FROM VW_ENDERECOS_ALUNOS_COM_RESPONSAVEIS A, ##ESCOLAS_PROXIMAS_309799 B 


WHERE A.CD_ESCOLA = 308799
AND FLOOR(FLOOR(SQRT(POWER(((LON_ALUNO*1000000) - (B.LON * 1000000) ),2) +  
				 POWER(((LAT_ALUNO*1000000) - (B.LAT * 1000000)),2)) / 10)/0.6)<=2000








