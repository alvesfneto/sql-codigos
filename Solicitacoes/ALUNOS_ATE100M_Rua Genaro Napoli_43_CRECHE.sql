/*Tendo em vista a inauguração programada para CEI INDIREITO na Rua Genaro Napoli, 43 Parque Residencial Cocaia, 
solicitamos relatório de alunos de BI, BII, MGI e MGII matriculados com distância de 1km para o endereço citado. 

No relatório deve conter
Nome do aluno
EOL DO ALUNO
UNIDADE DE MATRÍCULA
DISTÂNCIA DA UNIDADE DE MATRÍCULA
USO DE TEG
DISTANCIA PARA O ENDEREÇO CITADO - Rua Genaro Napoli, 43 (-23.743922385788913, -46.66982513213307)
ENDEREÇO COMPLETO
*/
DROP TABLE [##ALUNOS_ATE100M_Rua Genaro Napoli_43_CRECHE]
SELECT 
B.DRE,
B.CD_ESCOLA,
B.SG_TP_ESCOLA,
B.NOMESC,
A.SG_ETAPA,
A.SG_SERIE_ENSINO,
COD_ALUNO,
NM_ALUNO,
DATEDIFF(YY,A.DT_NASCIMENTO_ALUNO,GETDATE()) AS IDADE,
concat(C.TP_LOGRADOURO,' ',C.ENDEREÇO,', ',C.NR,' ',C.COMPL,' ',C.BAIRRO) AS END_ALUNO,
D.TEG,
C.DIST_ESCOLA,
'Rua Genaro Napoli, 43'AS DESTINO, 
FLOOR(FLOOR(SQRT(POWER((C.LAT_ALUNO * 1000000 - (-23.743922385788913 * 1000000) ),2) +  
				 POWER((C.LON_ALUNO * 1000000 - (-46.66982513213307 * 1000000)),2)) / 10)/0.6) AS DIST_DESTINO,
CONVERT(VARCHAR,A.CRDATE-1,103) AS DT_BASE

INTO [##ALUNOS_ATE100M_Rua Genaro Napoli_43_CRECHE]

 FROM SME_ALUNOS_DIARIO A
JOIN SME_ESCOLA_DIARIO B ON A.CD_ESCOLA=B.CD_ESCOLA
JOIN VW_ALUNOS_ENDERECOS C ON A.CD_ALUNO=C.COD_ALUNO
LEFT JOIN ALUNOS_COM_TEG D ON A.CD_ALUNO=D.CD_ALUNO
WHERE FLOOR(SQRT(POWER((C.LAT_ALUNO * 1000000 - (-23.743922385788913 * 1000000) ),2) +  
				 POWER((C.LON_ALUNO * 1000000 - (-46.66982513213307 * 1000000)),2)) / 10)/0.6<=1000
	 	 AND B.TP_ESCOLA<>15
	 AND A.SG_SERIE_ENSINO IN ('BERC I','BERC II','MG I','MG II')

--SELECT * FROM [##ALUNOS_ATE100M_Rua Genaro Napoli_43_CRECHE]

select top 10 * from VW_ALUNOS_ENDERECOS
	 
