--SELECIONA ESCOLAS DISTANTES ATÉ 1500 METROS DE OUTRA ESCOLA QUE DEVE SER SUBSTITUIDA/EXTINTA

USE Db_Local_0
/*DROP TABLE TAB_ESC
CREATE TABLE TAB_ESC (
	ID  INT IDENTITY(0,1),
	ENDERECO NVARCHAR(200) NULL,
	LAT FLOAT NULL,
	LON FLOAT NULL,
	DATA_GERACAO DATETIME NULL	)*/


TRUNCATE TABLE TAB_ESC
--SELECT * FROM TAB_ESC

--ENDEREÇO 1
DECLARE @END NVARCHAR(200) SET @END ='CEI MINA, COD EOL 400636'
DECLARE @LAT_Y FLOAT SET @LAT_Y = -23.619444     
DECLARE	@LON_X FLOAT SET @LON_X = -46.591201
INSERT INTO TAB_ESC  
SELECT @END,@LAT_Y, @LON_X,  SYSDATETIME() WHERE @LAT_Y IS NOT NULL
GO



SELECT 
B.ENDERECO AS ESC_ORIGEM,
DRE,
A.CD_ESCOLA,
SG_TP_ESCOLA,
NOMESC,
A.ENDERECO,
NR,
BAIRRO,
FLOOR(FLOOR(SQRT(POWER(((CD_COORDENADA_GEO_X*1000000) - (B.LON * 1000000) ),2) +  POWER(((CD_COORDENADA_GEO_Y*1000000)  - (B.LAT * 1000000)),2)) / 10)/0.6) AS DIST_400636,
CONVERT (VARCHAR, CRDATE-1, 103) AS DT_BASE

FROM SME_ESCOLA_DIARIO A, TAB_ESC B


WHERE (FLOOR(SQRT(POWER(((CD_COORDENADA_GEO_X*1000000) - (B.LON * 1000000) ),2) +  POWER(((CD_COORDENADA_GEO_Y*1000000)  - (B.LAT * 1000000)),2)) / 10)/0.6) <=1500
AND TP_ESCOLA IN (10,11,12,18,28,31)

--SELECT * FROM D_TIPO_ESCOLA